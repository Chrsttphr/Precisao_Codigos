
Option Explicit

Sub CriarTabelaComHiperlinks()
    Dim ws As Worksheet
    Dim wsSumario As Worksheet
    Dim i As Long
    Dim intervalo As Range
    Dim tabela As ListObject
    Dim btn As Shape
    Dim btnLeft As Double, btnTop As Double, btnWidth As Double, btnHeight As Double
    
    Const nmSumario As String = "Sumário"
    Const nmTabela As String = "tbSumarioPlanilhas"
    Const nmBotao As String = "btnAtualizarSumario"
    
    Application.ScreenUpdating = False
    Application.EnableEvents = False
    
    ' === Garantir planilha Sumário ===
    On Error Resume Next
    Set wsSumario = ThisWorkbook.Worksheets(nmSumario)
    On Error GoTo 0
    
    If wsSumario Is Nothing Then
        Set wsSumario = ThisWorkbook.Worksheets.Add(After:=Sheets(Sheets.Count))
        wsSumario.Name = nmSumario
    End If
    
    ' === Só alterar colunas A e B do Sumário ===
    With wsSumario
        .Columns("A:B").Clear           ' limpa conteúdo e formatação somente A:B
        .Range("A1").Value = "Nome da Planilha"
        .Range("B1").Value = "Link"
        
        ' Cabeçalho visível e com contraste
        With .Range("A1:B1")
            .Font.Bold = True
            .Font.Color = RGB(0, 0, 0)          ' preto
            .Interior.Color = RGB(217, 217, 217) ' cinza médio (não fica branco)
            .HorizontalAlignment = xlCenter
            .VerticalAlignment = xlCenter
        End With
    End With
    
    ' === Preencher linhas com nomes de planilhas e links ===
    i = 2
    For Each ws In ThisWorkbook.Worksheets
        If ws.Name <> wsSumario.Name Then
            ' Nome
            wsSumario.Cells(i, 1).Value = ws.Name
            
            ' Link para abrir a planilha
            wsSumario.Hyperlinks.Add _
                Anchor:=wsSumario.Cells(i, 2), _
                Address:="", _
                SubAddress:="'" & ws.Name & "'!A1", _
                TextToDisplay:="Acessar"
            wsSumario.Cells(i, 2).Font.ColorIndex = xlAutomatic
            
            ' === Garantir link único "Voltar ao Sumário" na linha 1 ===
            GarantirLinkVoltar ws, wsSumario
            
            i = i + 1
        End If
    Next ws
    
    ' === Criar/Atualizar Tabela em A:B ===
    Set intervalo = wsSumario.Range("A1:B" & i - 1)
    
    ' Remover tabela sobreposta em A:B se existir
    On Error Resume Next
    For Each tabela In wsSumario.ListObjects
        If Not Intersect(tabela.Range, wsSumario.Range("A:B")) Is Nothing Then
            tabela.Unlist
        End If
    Next tabela
    On Error GoTo 0
    
    Set tabela = wsSumario.ListObjects.Add(xlSrcRange, intervalo, , xlYes)
    tabela.Name = nmTabela
    tabela.TableStyle = "TableStyleMedium9" ' estilo visual agradável
    
    ' Formatação da área A:B
    With intervalo
        .Font.Name = "Arial"
        .Font.Size = 14
        .HorizontalAlignment = xlCenter
        .Borders(xlEdgeBottom).LineStyle = xlContinuous
        .Borders(xlEdgeLeft).LineStyle = xlContinuous
        .Borders(xlEdgeRight).LineStyle = xlContinuous
        .Borders(xlEdgeTop).LineStyle = xlContinuous
        .Borders(xlInsideHorizontal).LineStyle = xlContinuous
        .Borders(xlInsideVertical).LineStyle = xlContinuous
    End With
    
    wsSumario.Columns("A:B").AutoFit
    
    ' Borda externa espessa e escura
    With tabela.Range.Borders(xlEdgeBottom)
        .LineStyle = xlContinuous: .Weight = xlThick: .Color = RGB(64, 64, 64)
    End With
    With tabela.Range.Borders(xlEdgeLeft)
        .LineStyle = xlContinuous: .Weight = xlThick: .Color = RGB(64, 64, 64)
    End With
    With tabela.Range.Borders(xlEdgeRight)
        .LineStyle = xlContinuous: .Weight = xlThick: .Color = RGB(64, 64, 64)
    End With
    With tabela.Range.Borders(xlEdgeTop)
        .LineStyle = xlContinuous: .Weight = xlThick: .Color = RGB(64, 64, 64)
    End With
    
    ' === Botão em C1 (com largura estendida para acomodar o texto) ===
    On Error Resume Next
    wsSumario.Shapes(nmBotao).Delete
    On Error GoTo 0
    
    ' Dimensão do botão: começa em C1 e ocupa C1:E1 (sem alterar células)
    btnLeft = wsSumario.Range("C1").Left + 4
    btnTop = wsSumario.Range("C1").Top + 2
    btnWidth = wsSumario.Range("C1:E1").Width - 8
    btnHeight = wsSumario.Range("C1").Height + 8
    
    Set btn = wsSumario.Shapes.AddShape( _
        Type:=msoShapeRoundedRectangle, _
        Left:=btnLeft, _
        Top:=btnTop, _
        Width:=btnWidth, _
        Height:=btnHeight)
        
    With btn
        .Name = nmBotao
        .Fill.ForeColor.RGB = RGB(0, 122, 204)   ' Azul Office
        .Fill.Transparency = 0.06
        .Line.ForeColor.RGB = RGB(255, 255, 255)
        .Line.Weight = 1.5
        .Shadow.Visible = msoTrue
        
        ' Texto do botão
        .TextFrame2.TextRange.Characters.Text = "Atualizar Sumário"
        With .TextFrame2.TextRange.Characters
            .Font.Name = "Segoe UI"
            .Font.Size = 14
            .Font.Fill.ForeColor.RGB = RGB(255, 255, 255)
            .Font.Bold = msoTrue
        End With
        
        ' Alinhamentos corretos com TextFrame2:
        .TextFrame2.TextRange.ParagraphFormat.Alignment = msoAlignCenter   ' horizontal
        .TextFrame2.VerticalAnchor = msoAnchorMiddle                       ' vertical
        
        ' Fallback (compatibilidade) usando TextFrame clássico
        On Error Resume Next
        .TextFrame.HorizontalAlignment = xlCenter
        .TextFrame.VerticalAlignment = xlCenter
        On Error GoTo 0
        
        ' Ao clicar, executa novamente esta macro
        .OnAction = "CriarTabelaComHiperlinks"
    End With
    
    Application.EnableEvents = True
    Application.ScreenUpdating = True
    
    MsgBox "Sumário atualizado com sucesso!", vbInformation
End Sub

' ===========================================================
' Garante que exista apenas UM link "Voltar ao Sumário" na linha 1
' - Se existir, formata e mantém
' - Se houver múltiplos, remove extras
' - Se não existir, cria na primeira célula vazia da linha 1 (até col 50)
' ===========================================================
Private Sub GarantirLinkVoltar(ByVal ws As Worksheet, ByVal wsSumario As Worksheet)
    Dim hl As Hyperlink
    Dim linkPrincipal As Hyperlink
    Dim countLinks As Long
    Dim alvoSubAddress As String
    Dim rngLinha1 As Range
    Dim c As Range
    
    alvoSubAddress = "'" & wsSumario.Name & "'!A1"
    Set rngLinha1 = ws.Range(ws.Cells(1, 1), ws.Cells(1, 50)) ' A1:AX1 aprox
    
    ' Contar e identificar links que apontam para o Sumário
    countLinks = 0
    For Each hl In ws.Hyperlinks
        If hl.SubAddress = alvoSubAddress Then
            countLinks = countLinks + 1
            If linkPrincipal Is Nothing Then Set linkPrincipal = hl
        End If
    Next hl
    
    ' Se houver mais de um, remove extras (mantém o primeiro encontrado)
    If countLinks > 1 Then
        For Each hl In ws.Hyperlinks
            If hl.SubAddress = alvoSubAddress Then
                If hl Is linkPrincipal Then
                    ' mantém
                Else
                    hl.Delete
                End If
            End If
        Next hl
        countLinks = 1
    End If
    
    ' Se já existe um, apenas formata a célula desse link e encerra
    If countLinks = 1 Then
        With linkPrincipal.Range
            .Value = "? Voltar ao Sumário"
            .Font.Color = RGB(0, 102, 204)
            .Font.Bold = True
            .Interior.Color = RGB(222, 235, 247)
            .HorizontalAlignment = xlCenter
            .VerticalAlignment = xlCenter
            .EntireColumn.AutoFit
        End With
        Exit Sub
    End If
    
    ' Não existe ainda: criar na primeira célula vazia da linha 1 (até col 50)
    For Each c In rngLinha1
        If Len(c.Value) = 0 Then
            ws.Hyperlinks.Add _
                Anchor:=c, Address:="", SubAddress:=alvoSubAddress, _
                TextToDisplay:="? Voltar ao Sumário"
            With c
                .Font.Color = RGB(0, 102, 204)
                .Font.Bold = True
                .Interior.Color = RGB(222, 235, 247)
                .HorizontalAlignment = xlCenter
                .VerticalAlignment = xlCenter
                .EntireColumn.AutoFit
            End With
            Exit For
        End If
    Next c
End Sub

✅ O que a macro faz
Configuração inicial
Define a planilha ativa como base para criar a tabela.
Remove qualquer tabela anterior chamada “TabelaPlanilhas” para evitar duplicidade.

Criação dos cabeçalhos
Insere os títulos “Nome da Planilha” e “Link” nas colunas A e B.

Geração da lista de planilhas com hiperlinks
Percorre todas as planilhas do arquivo.
Para cada planilha (exceto a atual), adiciona:
O nome da planilha na coluna A.
Um hiperlink na coluna B que leva diretamente à célula A1 dessa planilha.

Em cada planilha listada, também cria um hiperlink chamado “Voltar à Tabela Principal”, permitindo navegação reversa para a planilha principal.

Formatação da tabela
Cria uma tabela estruturada com os nomes e links.
Aplica estilo, bordas, alinhamento central, fonte Arial tamanho 15 e ajusta largura das colunas.
Adiciona bordas espessas ao redor da tabela para destaque.

Feedback ao usuário
Exibe uma mensagem informando que a tabela foi criada com sucesso.

✅ Para que serve
Essa macro é ideal para arquivos com muitas planilhas, pois cria um menu interativo que facilita a navegação. Em vez de procurar manualmente cada aba, o usuário pode clicar em um link na tabela para ir direto à planilha desejada e, dentro dessa planilha, usar o link de retorno para voltar ao índice principal.

✅ Benefícios
Organização: Cria um índice central para todas as planilhas.
Agilidade: Navegação rápida sem precisar percorrer abas.
Automação completa: Atualiza links automaticamente e aplica formatação profissional.
