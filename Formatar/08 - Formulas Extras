' Este m√≥dulo cont√©m as seguintes fun√ß√µes personalizadas:
' 
' 1. DifPercentual: Calcula a diferen√ßa percentual entre dois valores.
' 2. ContarOcorrencias: Conta ocorr√™ncias de um valor em m√∫ltiplos intervalos.
' 3. NEsimoMaior: Encontra o N-√©simo maior valor em um intervalo.
' 4. BubbleSort: Fun√ß√£o auxiliar para ordenar um array (n√£o usada diretamente).
' 5. TextoParaNumero: Converte texto em n√∫mero de forma personalizada.
' 6. MediaPonderada: Calcula a m√©dia ponderada de um conjunto de valores.
' 7. Mediana: Encontra a mediana de um intervalo.
' 8. ConcatenarIntervalos: Concatena intervalos de c√©lulas com um separador.
' 9. RemoverEspacosExtras: Remove espa√ßos extras de um texto.
' 10. ContarPalavras: Conta o n√∫mero de palavras em uma c√©lula de texto.
' 11. ContemTexto: Verifica se uma c√©lula cont√©m texto.
' 12. UltimaOcorrencia: Encontra a √∫ltima ocorr√™ncia de um valor em um intervalo.
' 13. ValorFuturo: Calcula o valor futuro com base em juros compostos.
' 14. SomaValoresUnicos: Soma todos os valores √∫nicos em um intervalo.

' Fun√ß√£o para calcular a diferen√ßa percentual entre dois valores
Function DifPercentual(valor1 As Double, valor2 As Double) As Double
    If valor1 = 0 Then
        DifPercentual = 0
    Else
        DifPercentual = (valor2 - valor1) / Abs(valor1)
    End If
End Function

' Fun√ß√£o para contar ocorr√™ncias em m√∫ltiplos intervalos
Function ContarOcorrencias(rng1 As Range, rng2 As Range, valor As Variant) As Long
    ContarOcorrencias = Application.WorksheetFunction.CountIf(rng1, valor) + Application.WorksheetFunction.CountIf(rng2, valor)
End Function

' Fun√ß√£o para encontrar o N-√©simo maior valor
Function NEsimoMaior(rng As Range, n As Integer) As Double
    Dim valores() As Double
    Dim i As Integer
    
    ReDim valores(1 To rng.Count)
    i = 1
    For Each celula In rng
        valores(i) = celula.Value
        i = i + 1
    Next celula
    
    Call BubbleSort(valores)
    
    NEsimoMaior = valores(UBound(valores) - n + 1)
End Function

' Fun√ß√£o auxiliar para ordenar o array (Bubble Sort)
Private Sub BubbleSort(arr() As Double)
    Dim i As Integer, j As Integer
    Dim temp As Double
    
    For i = LBound(arr) To UBound(arr) - 1
        For j = i + 1 To UBound(arr)
            If arr(i) < arr(j) Then
                temp = arr(i)
                arr(i) = arr(j)
                arr(j) = temp
            End If
        Next j
    Next i
End Sub

' Fun√ß√£o para converter texto em n√∫mero de forma personalizada
Function TextoParaNumero(texto As String, divisor As Double) As Double
    TextoParaNumero = Val(texto) / divisor
End Function

' Fun√ß√£o para calcular a m√©dia ponderada
Function MediaPonderada(valores As Range, pesos As Range) As Double
    Dim somaPonderada As Double
    Dim somaPesos As Double
    Dim i As Integer
    
    For i = 1 To valores.Count
        somaPonderada = somaPonderada + (valores.Cells(i, 1).Value * pesos.Cells(i, 1).Value)
        somaPesos = somaPesos + pesos.Cells(i, 1).Value
    Next i
    
    If somaPesos <> 0 Then
        MediaPonderada = somaPonderada / somaPesos
    Else
        MediaPonderada = 0
    End If
End Function

' Fun√ß√£o para encontrar a mediana de um intervalo
Function Mediana(rng As Range) As Double
    Dim valores() As Double
    Dim i As Integer

    ReDim valores(1 To rng.Count)
    i = 1
    For Each celula In rng
        valores(i) = celula.Value
        i = i + 1
    Next celula

    Call BubbleSort(valores)

    If UBound(valores) Mod 2 = 1 Then
        Mediana = valores((UBound(valores) + 1) \ 2)
    Else
        Mediana = (valores(UBound(valores) \ 2) + valores((UBound(valores) \ 2) + 1)) / 2
    End If
End Function

' Fun√ß√£o para concatenar intervalos de c√©lulas com separador
Function ConcatenarIntervalos(rng As Range, separador As String) As String
    Dim celula As Range
    Dim resultado As String

    resultado = ""
    For Each celula In rng
        If resultado = "" Then
            resultado = celula.Value
        Else
            resultado = resultado & separador & celula.Value
        End If
    Next celula

    ConcatenarIntervalos = resultado
End Function

' Fun√ß√£o para remover espa√ßos extras de texto
Function RemoverEspacosExtras(texto As String) As String
    Dim resultado As String
    resultado = WorksheetFunction.Trim(texto)
    RemoverEspacosExtras = resultado
End Function

' Fun√ß√£o para contar palavras em uma c√©lula
Function ContarPalavras(texto As String) As Long
    Dim palavras() As String
    palavras = Split(texto, " ")
    ContarPalavras = UBound(palavras) + 1
End Function

' Fun√ß√£o para verificar se uma c√©lula cont√©m texto
Function ContemTexto(celula As Range) As Boolean
    ContemTexto = Application.WorksheetFunction.IsText(celula.Value)
End Function

' Fun√ß√£o para encontrar a √∫ltima ocorr√™ncia de um valor em um intervalo
Function UltimaOcorrencia(rng As Range, valor As Variant) As Variant
    Dim i As Long
    
    For i = rng.Cells.Count To 1 Step -1
        If rng.Cells(i).Value = valor Then
            UltimaOcorrencia = rng.Cells(i).Address
            Exit Function
        End If
    Next i
    
    UltimaOcorrencia = CVErr(xlErrValue)
End Function

' Fun√ß√£o para calcular o valor futuro com juros compostos
Function ValorFuturo(capital As Double, taxa As Double, periodo As Integer) As Double
    ValorFuturo = capital * (1 + taxa) ^ periodo
End Function

' Fun√ß√£o para calcular a soma de todos os valores √∫nicos em um intervalo
Function SomaValoresUnicos(rng As Range) As Double
    Dim celula As Range
    Dim valoresUnicos As New Collection
    Dim total As Double
    Dim valor As Variant

    On Error Resume Next
    For Each celula In rng
        valoresUnicos.Add celula.Value, CStr(celula.Value)
    Next celula
    On Error GoTo 0

    For Each valor In valoresUnicos
        total = total + valor
    Next valor

    SomaValoresUnicos = total
End Function

‚úÖ Vis√£o geral do m√≥dulo
Este m√≥dulo re√∫ne fun√ß√µes personalizadas para an√°lise e tratamento de dados em Excel/VBA, cobrindo compara√ß√£o percentual, contagens, estat√≠stica (mediana, N-√©simo maior), concatena√ß√£o de textos, limpeza (trim), checagem de tipo, busca de √∫ltima ocorr√™ncia, c√°lculo financeiro e soma de valores √∫nicos.

‚úÖ O que cada fun√ß√£o faz
1) DifPercentual(valor1, valor2) As Double
O que faz:
Calcula a diferen√ßa percentual entre valor2 e valor1, usando a base como |valor1|.
Se valor1 = 0, retorna 0 para evitar divis√£o por zero.

Para que serve:
Comparar evolu√ß√£o entre per√≠odos (ex.: m√™s atual vs. m√™s anterior).

Benef√≠cios:
Simples, evita erro por divis√£o por zero.

Observa√ß√£o/melhoria:
Se quiser sinalizar quando valor1 = 0 e valor2 <> 0, pode retornar #DIV/0! ou uma nota espec√≠fica.

2) ContarOcorrencias(rng1, rng2, valor) As Long
O que faz:
Soma a contagem de valor em dois intervalos (CountIf em rng1 + rng2).

Para que serve:
Contar apari√ß√µes em √°reas diferentes (ex.: duas colunas ou duas planilhas).

Benef√≠cios:
Pr√°tico, direto e usa fun√ß√£o nativa r√°pida.

3) NEsimoMaior(rng, n) As Double
O que faz:
Cria um array dos valores do intervalo, ordena em ordem decrescente com BubbleSort e retorna o N-√©simo maior.

Para que serve:
An√°lise de ranking (ex.: 1¬∫ maior, 2¬∫ maior‚Ä¶).

Benef√≠cios:
Funciona sem depender da fun√ß√£o de planilha.

Observa√ß√µes/melhorias:
Performance: BubbleSort √© O(n¬≤). Para intervalos grandes, use WorksheetFunction.Large(rng, n) ou ordena√ß√£o mais eficiente (QuickSort).
Valida√ß√£o: Trate n fora do limite (ex.: n > Count) para evitar erro.

4) BubbleSort(arr())
O que faz:
Ordena o array em ordem decrescente (troca quando arr(i) < arr(j)).

Para que serve:
Suporte para NEsimoMaior e Mediana.

Benef√≠cios:
Simples e did√°tico.

Observa√ß√£o:
Para listas grandes, √© melhor substituir por m√©todo mais eficiente.

5) TextoParaNumero(texto, divisor) As Double
O que faz:
Converte texto em n√∫mero com Val e divide pelo divisor.

Para que serve:
Padronizar importa√ß√µes onde n√∫meros v√™m como string (ex.: ‚Äú001234‚Äù).

Benef√≠cios:
Evita erros de convers√£o com s√≠mbolos.

Observa√ß√£o/melhoria:
Val para em caracteres n√£o num√©ricos (ex.: ‚Äú123A‚Äù ‚Üí 123). Se isso n√£o for desejado, valide com regex ou IsNumeric.

6) MediaPonderada(valores, pesos) As Double
O que faz:
Calcula ‚àë(valor‚àópeso)/‚àë(peso)\sum (valor * peso) / \sum (peso)‚àë(valor‚àópeso)/‚àë(peso). Retorna 0 se soma de pesos = 0.

Para que serve:
Notas ponderadas, √≠ndices ponderados, KPIs.

Benef√≠cios:
Robusto, evita divis√£o por zero.

Observa√ß√µes:
Valide que valores.Count = pesos.Count.
Trate vazios e erros se necess√°rio.

7) Mediana(rng) As Double
O que faz:
Copia os valores para um array, ordena (decrescente) e calcula a mediana:
Se n √© √≠mpar ‚Üí valor do meio.
Se n √© par ‚Üí m√©dia dos dois do meio.

Para que serve:
Medida de tend√™ncia central menos sens√≠vel a outliers.

Benef√≠cios:
√ötil para dados assim√©tricos.

Observa√ß√£o/melhoria:
Ordenar em crescente √© mais intuitivo (n√£o muda o resultado, mas facilita confer√™ncia).
Pode usar WorksheetFunction.Median(rng) para performance.

8) ConcatenarIntervalos(rng, separador) As String
O que faz:
Percorre o intervalo e junta os valores, separando pelo separador.

Para que serve:
Criar listas (ex.: ‚ÄúID1;ID2;ID3‚Äù), montar chaves compostas.

Benef√≠cios:
Simples, controlado pelo separador.

Observa√ß√µes/melhorias:
Ignorar c√©lulas vazias (se desejar).
Tratar c√©lulas com erro e trim dos textos para evitar espa√ßos.

9) RemoverEspacosExtras(texto) As String
O que faz:
Aplica WorksheetFunction.Trim(texto) para remover espa√ßos extras (m√∫ltiplos espa√ßos viram um s√≥; espa√ßos no in√≠cio/fim s√£o removidos).

Para que serve:
Limpeza de dados antes de compara√ß√£o/joins.

Benef√≠cios:
Padroniza entrada de textos.

10) ContarPalavras(texto) As Long
O que faz:
Divide o texto por espa√ßo " " e retorna a quantidade de partes.

Para que serve:
An√°lise b√°sica de conte√∫do textual (ex.: resumos).

Observa√ß√µes/melhorias:
Trate m√∫ltiplos espa√ßos e pontua√ß√£o (use Split(WorksheetFunction.Trim(texto), " ")).
Considerar que h√≠fens/virgulas podem afetar contagem.

11) ContemTexto(celula) As Boolean
O que faz:
Retorna True se o conte√∫do da c√©lula √© texto (IsText).

Para que serve:
Filtrar c√©lulas textuais (ex.: validar campos de descri√ß√£o).

Benef√≠cios:
Simples e usa fun√ß√£o nativa.

12) UltimaOcorrencia(rng, valor)
O que faz:
Percorre de tr√°s para frente e retorna o Address da √∫ltima c√©lula com valor. Se n√£o encontrar, retorna #VALUE!.

Para que serve:
Localizar √∫ltima apari√ß√£o (ex.: √∫ltima venda de um produto).

Benef√≠cios:
R√°pido e direto.

Observa√ß√µes/melhorias:
Pode retornar a c√©lula/Range em vez de endere√ßo, se desejar manipula√ß√£o direta.
Use Find com SearchOrder:=xlByRows, SearchDirection:=xlPrevious para performance.

13) ValorFuturo(capital, taxa, periodo) As Double
O que faz:
Calcula juros compostos: VF=capital√ó(1+taxa)periodoVF = capital \times (1 + taxa)^{periodo}VF=capital√ó(1+taxa)periodo.

Para que serve:
Proje√ß√µes financeiras, crescimento de investimentos.

Benef√≠cios:
Confi√°vel e simples.

Observa√ß√µes:
taxa deve ser decimal (ex.: 5% ‚Üí 0,05).
Pode adicionar aporte peri√≥dico se necess√°rio.

14) SomaValoresUnicos(rng) As Double
O que faz:
Usa uma Collection para deduplicar valores (chave = CStr(valor)) e soma apenas os √∫nicos.

Para que serve:
Somar sem contar duplicados (ex.: valores distintos por ID).

Benef√≠cios:
Evita repeti√ß√£o de soma.

Observa√ß√µes/melhorias:
Convertendo chave com CStr, n√∫meros como 1 e texto "1" s√£o considerados iguais. Se isso n√£o for desejado, diferencie tipos.
C√©lulas com erro podem causar problemas; inserir verifica√ß√£o.

‚úÖ Benef√≠cios do m√≥dulo
Cobertura ampla: Fun√ß√µes para estat√≠stica, texto, busca, finan√ßas e contagens.
Reuso: Pode ser chamado direto na planilha como UDFs.
Praticidade: Centraliza rotinas comuns de an√°lise que voc√™ usa no dia a dia.

üõ†Ô∏è Sugest√µes de melhorias r√°pidas
Tratamento de erros nas fun√ß√µes que percorrem intervalos (ignorar c√©lulas com erro).
Tipagem expl√≠cita de vari√°veis (Dim celula As Range em fun√ß√µes que usam For Each celula).
Performance: Trocar BubbleSort por WorksheetFunction.Large/Median ou QuickSort para intervalos maiores.
Valida√ß√µes: Em fun√ß√µes como NEsimoMaior, validar n entre 1 e rng.Count.
